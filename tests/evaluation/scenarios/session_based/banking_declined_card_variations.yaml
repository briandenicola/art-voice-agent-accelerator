# yaml-language-server: $schema=../scenario.schema.json
# ═══════════════════════════════════════════════════════════════════════════════
# Banking Declined Card - Variations Evaluation
# ═══════════════════════════════════════════════════════════════════════════════
# Tests various declined card scenarios with different user behaviors
#
# Variations Covered:
# 1. User knows exact card name
# 2. User describes card by color/feature
# 3. User is frustrated/emotional
# 4. User already tried something
# 5. User has only one card (no disambiguation needed)
#
# Purpose: Ensure agent handles edge cases without verbose assumptions
# ═══════════════════════════════════════════════════════════════════════════════

scenario_name: banking_declined_card_variations
description: |
  Test various declined card scenarios to ensure agent handles edge cases
  appropriately without making assumptions or providing verbose explanations.

# Demo user for edge case testing
demo_user:
  full_name: "Alex Martinez"
  email: "alex.martinez@example.com"
  phone_number: "+18885557777"
  scenario: banking
  seed: 789
  persist: false

session_config:
  agents:
    - BankingConcierge
    - DeclineSpecialist

  start_agent: BankingConcierge
  handoff_type: announced

  handoffs:
    - from: BankingConcierge
      to: DeclineSpecialist
      tool: handoff_decline_specialist
      type: discrete
      share_context: true
      handoff_condition: |
        Transfer to DeclineSpecialist when the customer:
        - Reports a declined card transaction
        - Asks why their card was declined

    - from: DeclineSpecialist
      to: BankingConcierge
      tool: handoff_concierge
      type: discrete
      share_context: true

  generic_handoff:
    enabled: true
    allowed_targets:
      - DeclineSpecialist
      - BankingConcierge
    default_type: announced
    share_context: true

  agent_defaults:
    institution_name: "Contoso Bank"
    industry: "banking"

agent_overrides:
  - agent: BankingConcierge
    model_override:
      deployment_id: gpt-4o
      temperature: 0.7
      max_tokens: 500

  - agent: DeclineSpecialist
    model_override:
      deployment_id: gpt-4o
      temperature: 0.6
      max_tokens: 500

# ═══════════════════════════════════════════════════════════════════════════════
# Variation Test Turns
# ═══════════════════════════════════════════════════════════════════════════════
# Each turn pair tests a different user behavior pattern
# ═══════════════════════════════════════════════════════════════════════════════

turns:
  # ─────────────────────────────────────────────────────────────────────────────
  # Variation 1: User is FRUSTRATED - agent should acknowledge emotion first
  # ─────────────────────────────────────────────────────────────────────────────
  - turn_id: turn_1_frustrated_user
    user_input: "This is ridiculous! My card was declined AGAIN at the grocery store!"
    expectations:
      tools_optional:
        - get_user_profile
        - verify_client_identity
      # Should NOT immediately hand off - acknowledge frustration first
      tools_forbidden:
        - handoff_decline_specialist
        - handoff_to_agent
      no_handoff: true
      response_constraints:
        # Brief empathy + clarifying question
        max_tokens: 70
        # Should NOT be overly apologetic or verbose
        must_not_include:
          - "I completely understand"
          - "I sincerely apologize"
          - "let me explain"

  # ─────────────────────────────────────────────────────────────────────────────
  # Variation 2: User already tried something - agent should NOT suggest it
  # ─────────────────────────────────────────────────────────────────────────────
  - turn_id: turn_2_already_tried
    user_input: "I already tried calling the number on the back of the card."
    expectations:
      tools_called: []
      tools_optional:
        - get_user_profile
      no_handoff: true
      response_constraints:
        max_tokens: 60
        # Should NOT suggest calling the number
        must_not_include:
          - "call the number"
          - "number on the back"
        # Should ask for more info
        must_ask_for:
          - "which card"

  # ─────────────────────────────────────────────────────────────────────────────
  # Variation 3: User describes card by appearance (not official name)
  # ─────────────────────────────────────────────────────────────────────────────
  - turn_id: turn_3_card_by_appearance
    user_input: "The one with the mountains on it, the blue and white card."
    expectations:
      tools_optional:
        - get_user_profile
      # Agent should match this to a card, but may need to confirm
      no_handoff: true
      response_constraints:
        max_tokens: 80
        # May ask to confirm, but should NOT ask for card number
        must_not_include:
          - "card number"
          - "16-digit"
          - "last four digits"

  # ─────────────────────────────────────────────────────────────────────────────
  # Variation 4: User provides TOO much information upfront
  # Agent should NOT repeat it all back
  # ─────────────────────────────────────────────────────────────────────────────
  - turn_id: turn_4_info_overload
    user_input: "Yes that's my Travel Rewards card, I was at Target trying to buy groceries for $87.32 and it said declined at 3:45 PM today."
    expectations:
      tools_optional:
        - handoff_decline_specialist
        - handoff_to_agent
      handoff:
        to_agent: DeclineSpecialist
      response_constraints:
        # Brief acknowledgment, don't repeat all the details
        max_tokens: 50
        must_not_include:
          - "Target"
          - "$87"
          - "3:45"
          - "groceries"

  # ─────────────────────────────────────────────────────────────────────────────
  # Variation 5: With DeclineSpecialist - User asks follow-up about fees
  # Specialist should stay focused, not offer everything
  # ─────────────────────────────────────────────────────────────────────────────
  - turn_id: turn_5_tangent_question
    user_input: "Will I be charged a fee for this declined transaction?"
    expectations:
      tools_called: []
      tools_optional:
        - search_knowledge_base
      # Should NOT hand off back or offer unrelated services
      tools_forbidden:
        - handoff_concierge
        - handoff_to_agent
      no_handoff: true
      response_constraints:
        # Direct answer about fees
        max_tokens: 80
        # Should NOT pivot to other topics
        must_not_include:
          - "also recommend"
          - "while I have you"
          - "anything else"

  # ─────────────────────────────────────────────────────────────────────────────
  # Variation 6: User gives one-word answer
  # Agent should handle minimal input gracefully
  # ─────────────────────────────────────────────────────────────────────────────
  - turn_id: turn_6_minimal_input
    user_input: "No."
    expectations:
      tools_called: []
      no_handoff: true
      response_constraints:
        # Should NOT ask multiple questions
        max_tokens: 50

  # ─────────────────────────────────────────────────────────────────────────────
  # Variation 7: User wants to end conversation abruptly
  # Agent should comply, not try to keep them
  # ─────────────────────────────────────────────────────────────────────────────
  - turn_id: turn_7_end_conversation
    user_input: "Okay, I'll deal with it later. Bye."
    expectations:
      tools_called: []
      # Should NOT try to retain user or offer more services
      tools_forbidden:
        - search_knowledge_base
        - handoff_to_agent
      no_handoff: true
      response_constraints:
        max_tokens: 40
        must_not_include:
          - "before you go"
          - "is there anything"
          - "I can also"
          - "don't hesitate"

thresholds:
  min_tool_precision: 0.40  # Lower - many turns expect no/few tools
  min_tool_recall: 0.30
  min_grounded_ratio: 0.3
  max_latency_p95_ms: 10000

foundry_export:
  enabled: true
  output_filename: declined_card_variations_eval.jsonl
  context_source: evidence
  evaluators:
    - id: builtin.relevance
      init_params:
        deployment_name: gpt-4o
      data_mapping:
        query: "${data.query}"
        response: "${data.response}"
        context: "${data.context}"
    - id: builtin.coherence
      init_params:
        deployment_name: gpt-4o
      data_mapping:
        query: "${data.query}"
        response: "${data.response}"
    - id: builtin.fluency
      init_params:
        deployment_name: gpt-4o
      data_mapping:
        response: "${data.response}"
