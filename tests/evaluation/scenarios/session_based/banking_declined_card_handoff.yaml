# yaml-language-server: $schema=../scenario.schema.json
# ═══════════════════════════════════════════════════════════════════════════════
# Banking Declined Card - Core Flow Evaluation
# ═══════════════════════════════════════════════════════════════════════════════
# Consolidated core flow covering:
# 1. Turn discipline (no compound tool calls)
# 2. Multi-card disambiguation before handoff
# 3. Concise, voice-appropriate responses
# 4. DeclineSpecialist response after handoff
# ═══════════════════════════════════════════════════════════════════════════════

scenario_name: banking_declined_card_handoff
description: |
  Consolidated declined-card flow that tests turn discipline, clarity, and
  concise responses. Concierge clarifies the issue and card before handing off,
  then DeclineSpecialist handles the decline explanation and next steps.

# ═══════════════════════════════════════════════════════════════════════════════
# Demo User Configuration
# Creates a realistic user profile with cards, transactions, etc.
# Tools like get_user_profile and verify_client_identity use this data.
# ═══════════════════════════════════════════════════════════════════════════════
demo_user:
  full_name: "Sarah Johnson"
  email: "sarah.johnson@example.com"
  phone_number: "+18885551234"
  scenario: banking
  seed: 42  # Fixed seed for reproducible test data
  persist: false  # Don't persist to database for eval runs

session_config:
  agents:
    - BankingConcierge
    - DeclineSpecialist

  start_agent: BankingConcierge

  handoff_type: announced

  handoffs:
    - from: BankingConcierge
      to: DeclineSpecialist
      tool: handoff_decline_specialist
      type: discrete
      share_context: true
      handoff_condition: |
        Transfer to DeclineSpecialist when the customer:
        - Reports a declined card transaction
        - Asks why their card was declined
        - Needs help resolving a declined purchase

    - from: DeclineSpecialist
      to: BankingConcierge
      tool: handoff_concierge
      type: discrete
      share_context: true

  generic_handoff:
    enabled: true
    allowed_targets:
      - DeclineSpecialist
      - BankingConcierge
    default_type: announced
    share_context: true

  agent_defaults:
    institution_name: "Contoso Bank"
    industry: "banking"

# Model overrides for consistent evaluation
agent_overrides:
  - agent: BankingConcierge
    model_override:
      deployment_id: gpt-4o
      temperature: 0.7
      max_tokens: 500

  - agent: DeclineSpecialist
    model_override:
      deployment_id: gpt-4o
      temperature: 0.6
      max_tokens: 500

# ═══════════════════════════════════════════════════════════════════════════════
# Test Turns
# ═══════════════════════════════════════════════════════════════════════════════
# Flow under test:
# 1. Vague complaint → Concierge asks clarifying question (no premature tools)
# 2. Declined report → Concierge looks up account, asks which card
# 3. Card identified → Concierge hands off to DeclineSpecialist
# 4. Specialist explains decline when asked (no unsolicited advice)
# 5. Specialist offers a single next step when asked
#
# BEHAVIOR CHECKS:
# - Turn discipline: No compound tool calls in a single turn
# - Concision: Voice-appropriate length limits
# - Handoff clarity: No specialist response embedded in handoff
# ═══════════════════════════════════════════════════════════════════════════════

turns:
  # Turn 1: Vague complaint - no premature lookups or handoff
  - turn_id: turn_1_vague_complaint
    user_input: "I have a problem with my card."
    expectations:
      tools_called: []
      tools_optional:
        - get_user_profile
        - verify_client_identity
      tools_forbidden:
        - lookup_decline_code
        - handoff_decline_specialist
        - handoff_to_agent
        - get_recent_transactions
      no_handoff: true
      response_constraints:
        must_ask_for:
          - "help"
        max_tokens: 60

  # Turn 2: User reports decline, but doesn't specify card
  - turn_id: turn_2_declined_no_card_specified
    user_input: "It got declined at the store."
    expectations:
      tools_called:
        - get_user_profile
      tools_optional:
        - verify_client_identity
      tools_forbidden:
        - lookup_decline_code
        - handoff_decline_specialist
        - handoff_to_agent
      no_handoff: true
      response_constraints:
        must_ask_for:
          - "which card"
        max_tokens: 80
        must_not_include:
          - "common reasons"
          - "usually means"

  # Turn 3: User specifies the Marketplace card - handoff only
  - turn_id: turn_3_card_identified_handoff_only
    user_input: "The Marketplace one."
    expectations:
      tools_called: []
      tools_optional:
        - handoff_decline_specialist
        - handoff_to_agent
      tools_forbidden:
        - lookup_decline_code
        - get_recent_transactions
      handoff:
        to_agent: DeclineSpecialist
      response_constraints:
        max_tokens: 60
        must_not_include:
          - "I can see"
          - "decline code"
          - "transaction"

  # Turn 4: With DeclineSpecialist - explain when asked, no unsolicited advice
  - turn_id: turn_4_decline_code_question
    user_input: "What does that decline code 55 mean?"
    expectations:
      tools_called: []
      tools_optional:
        - lookup_decline_code
        - search_decline_codes
        - get_recent_transactions
      no_handoff: true
      response_constraints:
        max_tokens: 120
        must_not_include:
          - "I recommend"
          - "you should"
          - "next steps"

  # Turn 5: User asks for next steps - keep it short
  - turn_id: turn_5_what_to_do
    user_input: "What can I do to fix this?"
    expectations:
      tools_called: []
      tools_optional:
        - search_knowledge_base
        - get_account_summary
      no_handoff: true
      response_constraints:
        max_tokens: 100
        must_not_include:
          - "step 1"
          - "first, second"
          - "here are your options"

# Evaluation thresholds
thresholds:
  min_tool_precision: 0.60
  min_tool_recall: 0.50
  min_grounded_ratio: 0.5
  max_latency_p95_ms: 10000

# Azure AI Foundry export for detailed analysis
foundry_export:
  enabled: true
  output_filename: declined_card_handoff_eval.jsonl
  context_source: evidence
  evaluators:
    - id: builtin.relevance
      init_params:
        deployment_name: gpt-4o
      data_mapping:
        query: "${data.query}"
        response: "${data.response}"
        context: "${data.context}"
    - id: builtin.coherence
      init_params:
        deployment_name: gpt-4o
      data_mapping:
        query: "${data.query}"
        response: "${data.response}"
