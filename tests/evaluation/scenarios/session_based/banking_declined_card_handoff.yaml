# yaml-language-server: $schema=../scenario.schema.json
# ═══════════════════════════════════════════════════════════════════════════════
# Banking Declined Card Handoff Evaluation
# ═══════════════════════════════════════════════════════════════════════════════
# Tests the flow when a customer reports a declined card and has multiple cards
# on their account. Specifically validates:
# 1. Concierge performs account lookup when user reports decline
# 2. Concierge asks which card when multiple cards are found
# 3. Handoff to DeclineSpecialist occurs with correct context
# 4. DeclineSpecialist responds appropriately after handoff
# ═══════════════════════════════════════════════════════════════════════════════

scenario_name: banking_declined_card_handoff
description: |
  Test multi-card declined transaction flow: Concierge identifies multiple cards,
  asks user which one, then hands off to DeclineSpecialist. Validates that the
  DeclineSpecialist responds after receiving the handoff.

session_config:
  agents:
    - BankingConcierge
    - DeclineSpecialist

  start_agent: BankingConcierge

  handoff_type: announced

  handoffs:
    - from: BankingConcierge
      to: DeclineSpecialist
      tool: handoff_decline_specialist
      type: discrete
      share_context: true
      handoff_condition: |
        Transfer to DeclineSpecialist when the customer:
        - Reports a declined card transaction
        - Asks why their card was declined
        - Needs help resolving a declined purchase

    - from: DeclineSpecialist
      to: BankingConcierge
      tool: handoff_concierge
      type: discrete
      share_context: true

  generic_handoff:
    enabled: true
    allowed_targets:
      - DeclineSpecialist
      - BankingConcierge
    default_type: announced
    share_context: true

  agent_defaults:
    institution_name: "Contoso Bank"
    industry: "banking"

# Model overrides for consistent evaluation
agent_overrides:
  - agent: BankingConcierge
    model_override:
      deployment_id: gpt-4o
      temperature: 0.7
      max_tokens: 500

  - agent: DeclineSpecialist
    model_override:
      deployment_id: gpt-4o
      temperature: 0.6
      max_tokens: 500

# ═══════════════════════════════════════════════════════════════════════════════
# Test Turns
# ═══════════════════════════════════════════════════════════════════════════════
# Flow under test:
# 1. User reports declined card → Concierge looks up account, finds multiple cards
# 2. User specifies which card → Concierge hands off to DeclineSpecialist
# 3. DeclineSpecialist should respond with decline information
# ═══════════════════════════════════════════════════════════════════════════════

turns:
  # Turn 1: User reports declined card (identity already verified in prior context)
  - turn_id: turn_1
    user_input: "Hi, my card was just declined. Can you tell me why?"
    expectations:
      # Concierge should look up user profile to see their cards
      tools_called:
        - get_user_profile
      tools_optional:
        - verify_client_identity
      # Should NOT hand off yet - needs to determine which card
      no_handoff: true
      response_constraints:
        # Should ask which card since user has multiple
        must_ask_for:
          - "which card"

  # Turn 2: User specifies the Marketplace card
  - turn_id: turn_2
    user_input: "The Marketplace one."
    expectations:
      # Now should trigger handoff to DeclineSpecialist
      # Model may use generic handoff_to_agent or specific handoff_decline_specialist
      tools_called: []
      tools_optional:
        - handoff_decline_specialist
        - handoff_to_agent
      handoff:
        to_agent: DeclineSpecialist

  # Turn 3: Verify DeclineSpecialist responds appropriately
  - turn_id: turn_3
    user_input: "What does that decline code mean?"
    expectations:
      # DeclineSpecialist should look up decline information
      tools_called: []
      tools_optional:
        - lookup_decline_code
        - search_decline_codes
        - get_recent_transactions
      # Should stay with DeclineSpecialist, no handoff back
      no_handoff: true
      response_constraints:
        # Response should address decline-related content
        must_include: []

  # Turn 4: Ask for resolution options
  - turn_id: turn_4
    user_input: "What can I do to fix this?"
    expectations:
      tools_called: []
      tools_optional:
        - search_knowledge_base
        - get_account_summary
      no_handoff: true

# Evaluation thresholds
thresholds:
  min_tool_precision: 0.60
  min_tool_recall: 0.50
  min_grounded_ratio: 0.5
  max_latency_p95_ms: 10000

# Azure AI Foundry export for detailed analysis
foundry_export:
  enabled: true
  output_filename: declined_card_handoff_eval.jsonl
  context_source: evidence
  evaluators:
    - id: builtin.relevance
      init_params:
        deployment_name: gpt-4o
      data_mapping:
        query: "${data.query}"
        response: "${data.response}"
        context: "${data.context}"
    - id: builtin.coherence
      init_params:
        deployment_name: gpt-4o
      data_mapping:
        query: "${data.query}"
        response: "${data.response}"
